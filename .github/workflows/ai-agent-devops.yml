name: Node.js CI with AI DevOps Auto-PR Agent

on:
  push:
    branches: [ main, "**" ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: |
          npm install 2>&1 | tee install.log

      - name: Run Tests
        run: |
          npm test 2>&1 | tee test.log
          TEST_EXIT=${PIPESTATUS[0]}
          if [ $TEST_EXIT -ne 0 ]; then
              echo "❌ npm test failed — stopping pipeline"
              exit $TEST_EXIT
          fi

      # --------------------------------------
      # OPTIONAL: Validate Dockerfile (build)
      # --------------------------------------
      - name: Try building Docker image (optional but useful)
        run: |
          docker build -t vdops/demo . 2>&1 | tee docker.log || true

      # ============================================================
      #          SEND FAILURE TO AI DEVOPS AGENT VIA N8N
      # ============================================================
      - name: Send Failure to AI DevOps Agent
        if: failure()
        env:
          #N8N_WEBHOOK_URL: "https://vdopspoc.app.n8n.cloud/webhook/github-failure-agent"
          N8N_WEBHOOK_URL: "https://vdopspoc.app.n8n.cloud/webhook/github-failure-agent"
        run: |
          echo "Preparing payload for n8n AI Agent..."

          bash scripts/gha-n8n.sh

      # Save logs for debugging
      - name: Upload CI Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-failure-logs
          path: |
            install.log
            test.log
            docker.log

